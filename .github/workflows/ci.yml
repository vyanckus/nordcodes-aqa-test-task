name: Java CI with Allure Report

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1. –ü–û–î–ì–û–¢–û–í–ö–ê: –ó–ê–ì–†–£–ó–ö–ê –ö–û–î–ê –ò –ù–ê–°–¢–†–û–ô–ö–ê JAVA
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 2. –ö–≠–®–ò–†–û–í–ê–ù–ò–ï Maven –î–õ–Ø –£–°–ö–û–†–ï–ù–ò–Ø –°–ë–û–†–ö–ò
      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      # 3. –£–°–¢–ê–ù–û–í–ö–ê –ù–ï–û–ë–•–û–î–ò–ú–´–• –£–¢–ò–õ–ò–¢
      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full

      # 4. –ó–ê–ì–†–£–ó–ö–ê –ò –†–ê–°–ü–ê–ö–û–í–ö–ê –¢–ï–°–¢–ò–†–£–ï–ú–û–ì–û –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (–ò–ó –¢–ó)
      - name: Download and extract tested application
        run: |
          echo "üì¶ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–∑ –¢–ó..."
          wget -q -O app.7z "https://gametests.nyc.wf/aqa.7z"
          7z x app.7z -o./app -p"g7%Kp9#rX2bL" -y
          echo "üìÅ –†–∞—Å–ø–∞–∫–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
          ls -la ./app/

      # 5. –ó–ê–ü–£–°–ö SPRING BOOT –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
      - name: Start Spring Boot application
        run: |
          echo "üöÄ –ó–∞–ø—É—Å–∫ Spring Boot –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          cd ./app
          # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ —Ñ–æ–Ω–µ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤ —Ñ–∞–π–ª
          java -jar -Dsecret=qazWSXedc -Dmock=http://localhost:8888/ internal-0.0.1-SNAPSHOT.jar > spring-app.log 2>&1 &
          echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (25 —Å–µ–∫—É–Ω–¥)..."
          sleep 25
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Ä—Ç 8080 —Å–ª—É—à–∞–µ—Ç—Å—è (–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ)
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          if curl -s -f http://localhost:8080 > /dev/null; then
            echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ –ø–æ—Ä—Ç—É 8080"
          else
            echo "‚ùå –û—à–∏–±–∫–∞: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å"
            echo "üìã –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
            cat spring-app.log
            exit 1
          fi

      # 6. –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í –° ALLURE –û–¢–ß–ï–¢–û–ú
      - name: Run tests with Allure
        run: |
          echo "üß™ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤..."
          echo "üìù –¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç:"
          echo "   - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¢–ó (–ø–∞–¥–∞—é—Ç –∏–∑-–∑–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–æ–∫–µ–Ω–∞)"
          echo "   - –§–∞–∫—Ç–∏—á–µ—Å–∫—É—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É (–∏—Å–ø–æ–ª—å–∑—É—é—Ç HEX-—Ç–æ–∫–µ–Ω—ã 0-9A-F)"
          echo "   - –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –≤–Ω–µ—à–Ω–∏–º —Å–µ—Ä–≤–∏—Å–æ–º —á–µ—Ä–µ–∑ WireMock"
          
          mvn clean test allure:report -Daspectj.skip=true
          
          echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤:"
          echo "   - –¢–µ—Å—Ç—ã –ø–æ –¢–ó –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è (–æ–∂–∏–¥–∞–µ–º–æ)"
          echo "   - –¢–µ—Å—Ç—ã —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ"
          echo "   - –ù–∞–π–¥–µ–Ω—ã –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –º–µ–∂–¥—É –¢–ó –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π"

      # 7. –î–ï–ü–õ–û–ô ALLURE –û–¢–ß–ï–¢–ê –ù–ê GITHUB PAGES
      - name: Deploy Allure Report to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: target/site/allure-maven-plugin/
          destination_dir: .  # –ö–æ—Ä–Ω–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–∞–π—Ç–∞
          keep_files: false   # –û—á–∏—â–∞—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—Ç—á–µ—Ç—ã

      # 8. –°–û–•–†–ê–ù–ï–ù–ò–ï –ê–†–¢–ï–§–ê–ö–¢–û–í –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê
      - name: Upload Allure report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: target/site/allure-maven-plugin/
          retention-days: 7

      - name: Upload application logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot-logs
          path: ./app/spring-app.log
          retention-days: 7

      - name: Upload test reports (Surefire XML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: target/surefire-reports/
          retention-days: 7

      # 9. –û–°–¢–ê–ù–û–í–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø –ò –û–ß–ò–°–¢–ö–ê
      - name: Stop Spring Boot application
        if: always()
        run: |
          echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Spring Boot –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          pkill -f "internal-0.0.1-SNAPSHOT.jar" || true
          sleep 2
          echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"